# くるっぽう: 技術仕様書

## 基本事項

- 開発プラットフォーム: iOS 11.0 + Xcode 9.0以降
(ARKitを使わないならiOS 9.x、10.xも対応可能)


- 画面配置にはAutoLayoutを使うほうが好ましい
(iPhoneXとか横画面とかに対応したければ)



### SwiftファイルとSceneの対応に関する方針
今回はピンの`callout`(吹き出し)に表示するための`View`を複数作っておいて、その内容を切り替えて画面遷移する(画面ごとに`extension`を使ってファイルを分け、コードの見通しをよくする)。

## 各画面について
1. ホーム画面
2. 閲覧画面
3. 新規投稿画面
4. 追記画面
5. 持ち歩き画面
6. 持ち歩き閲覧画面


~~*(閲覧画面、吹き出しだと表示領域が小さいのでは？)*~~
自機でモック画像を見てみたら意外と大丈夫そうだった(中武さすが)

## 画面の説明
### Storyboard
- 上部: `Navigation Bar`
  - 左: 現在地捕捉ボタン
  - 中央: タイトル文字列「現在地周辺」
  - 右: 新規投稿ボタン


- 中央部より下: `MKMapView`

**各吹出し: `View`のなかに要素を置いていく**
(あらかじめStoryboardで構成しておくが、`hidden`にチェックを入れておくことで隠せる)

- 閲覧用吹き出し
  - 上部: `ユーザー名`@`TwitterID`？
  - 中部: `ScrollView`の上に`Label`を載せる
  - 下部: `Button`の上に`Image`を載せる
(追記、持つボタン)


- 新規・追記投稿用吹き出し 
  - 上部
    - `ユーザー名`@`TwitterID`
    - 追記先投稿(`ユーザー名`@`TwitterID` + 投稿を示す`Label`)
※非表示にしておく

  - 中部: `TextView`の上に`Label`(「入力してください」)を載せる
文字色はグレースケールで80%前後

  - 下部: `Button`の上に`Image`(「持つ」)を載せる


- 「置く」ボタン (**画面5**用)
  - `NavigationBar`の下に配置する
  - 非表示状態にしておく
  
### ViewController

#### 画面1・2 (起動→ホーム画面、閲覧画面)

- **画面が読み込まれたとき**
  - ログイン
(端末にアクセスキーがあればアクセスキー確認処理を、そうでなければSafariに画面遷移)
(アクセスキーがあっても、確認処理で失敗したらアラートを出し、Safariに飛ばす)
  - パン検出機能を準備する
  - 位置情報を取得開始する
  - 地図を拡大する(`0.05, 0.05`)
  - TsukumoAPIを用いて投稿を取得する
MapViewが現在表示している座標をもとに投稿を取得する
投稿の内容も事前に取得する → **画面2**で使用

取得した投稿の緯度経度と、現在地の緯度経度の差が一定値以上であった場合は、その投稿の内容をピンに設定しないなどして非表示にする

- **マップをパン(手で移動)したとき**
  - 現在地の更新に応じた地図移動を停止する


- **マップをタップしたとき**
  - 吹き出しを非表示にする


- **現在地ボタンをタップしたとき**
  - 現在地の更新に応じた地図移動を再開する
  - 位置情報が許可されていないときはアラートを表示する


- **ピンをタップしたとき**
  - 吹き出し(`callout`)を表示する **(画面2)**
  - `callout`を出す方法は https://dev.classmethod.jp/smartphone/ios-mapkit/#toc-5-callout (iOS 9以降)を参照


- **「投稿」ボタンをタップしたとき**
  - 現在地に`MKAnnotationPin`を落とす
  - 閲覧用の`MKAnnotationView`を非表示にする
  - 事前に用意した新規投稿用`MKAnnotationView`を、現在地に立てたピンの`callout`にセットする **(画面3)**

#### 画面3・4 (新規投稿・追記投稿画面)

- **(画面2で)「追記」ボタンをタップしたとき**
  - すでにコメントを持っている場合
    - 「現在保持しているコメントを置いてください」というアラートを表示、以降の処理はスキップ
  - 吹き出しの追記先欄を書き換える
    - ユーザー名に、追記先の投稿者 + TwitterIDをセット
    - 本文に追記先の投稿の本文をセット
  - 吹き出しの追記先欄の非表示属性を解除する **(画面4)**


- **「入力してください」をタップしたとき**
  - プレースホルダを隠す
  - フォーカス (キーボード表示)の処理は、特に必要なし


- **文字を入力したとき**
  - テキストボックス内の文字列の長さが0以上なら「持つ」ボタンを有効にする
  - そうでなければ無効にする


- **「持つ」をタップしたとき**
  - Local DBに投稿を一時持つする
  - すでに投稿が持つされていたときは「現在保持しているコメントを置いてください」というアラートを表示する→終了
  - `callout`を非表示にする **(画面5へ)**
  
  
- **「×」をタップしたとき**
  - `callout`を非表示にする **(画面1へ)**


#### 画面5 (持ち歩き画面)

- `callout`は隠す
- 位置情報の計測と地図の移動を再開
- 現在地に円を表示するようにする
- 「置く」ボタンの非表示属性を解除する



- **「置く」ボタンをタップしたとき**
  - TsukumoAPIを使用して、サーバーへ投稿データを送信する
  - 送信が完了したら **(画面1へ)**
  - 「置く」ボタンを非表示にする



- **「投稿」ボタンをタップしたとき**
  - **画面3** の (新規投稿ボタンタップ時)と同じ処理を行う


- **「現在地」ボタンをタップしたとき**
  - `mapView`を、最後に取得できた座標に強制移動する
  - 位置情報が許可されていないときはアラートを表示する


- **持っているピン(地図上) をタップしたとき**
  - 投稿閲覧(**画面2**と共通)の`callout`を表示する

#### 画面6 (持ち歩き閲覧画面)
持っている投稿を確認する画面

- **「×」ボタンをタップしたとき**
  - 表示中の`callout`を非表示にする **(画面5へ)**


- **「編集」ボタンをタップしたとき**
  -  表示中の`callout`を非表示にする
  -  追記投稿の`callout`を表示する **(画面4へ)**
  -  追記先の投稿には、自分の持っている投稿をセットする


- **「持つ」ボタンをタップしたとき**
  - 「現在保持しているコメントを先に置いてください」というアラートを表示する

